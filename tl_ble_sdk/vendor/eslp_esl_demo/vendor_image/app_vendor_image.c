/********************************************************************************************************
 * @file    app_vendor_image.c
 *
 * @brief   This is the source file for BLE SDK
 *
 * @author  BLE GROUP
 * @date    01,2024
 *
 * @par     Copyright (c) 2024, Telink Semiconductor (Shanghai) Co., Ltd. ("TELINK")
 *
 *          Licensed under the Apache License, Version 2.0 (the "License");
 *          you may not use this file except in compliance with the License.
 *          You may obtain a copy of the License at
 *
 *              http://www.apache.org/licenses/LICENSE-2.0
 *
 *          Unless required by applicable law or agreed to in writing, software
 *          distributed under the License is distributed on an "AS IS" BASIS,
 *          WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *          See the License for the specific language governing permissions and
 *          limitations under the License.
 *
 *******************************************************************************************************/

#include "tl_common.h"
#include "drivers.h"
#include "stack/ble/ble.h"
#include "fonts.h"
#include "gui.h"
#include "app_vendor_image.h"

#if APP_VENDOR_IMAGE

    #define APP_VENDOR_IMAGE_RSP_OPCODE 0x00
    #define OPCODE_OP(opcode)           (0x0F & opcode)
    #define OPCODE_CAT(opcode)          ((opcode & 0xF0) >> 4)
    #define PRODUCT_NAME_LEN            24
    #define PRODUCT_PRICE_LEN           12
    #define PRODUCT_DESC_LEN            24
    #define BAR_CODE_LEN                24
    #define BAR_CODE_NUM_LEN            12
    #define PIC_LEN                     2
    #define PRODUCT_PRICE_MAJOR_LEN     5
    #define PRODUCT_PRICE_MINOR_LEN     3
    #define CURRENCY_CODE_LEN           4
    #define UNIT_OF_MEASURE_LEN         12

    #define PIC_DISPLAY                 0x01
    #define PIC_WIDTH                   48
    #define PIC_HEIGHT                  48
    #define PIC_SIZE                    288

// Type of operation
typedef enum
{
    APP_VENDOR_IMAGE_CMD_OPCODE_OP_CLEAR,
    APP_VENDOR_IMAGE_CMD_OPCODE_OP_PATCH,
    APP_VENDOR_IMAGE_CMD_OPCODE_OP_GET_LENGTH,
    APP_VENDOR_IMAGE_CMD_OPCODE_OP_GET_DATA,
    APP_VENDOR_IMAGE_CMD_OPCODE_OP_PATCH_V2,
    APP_VENDOR_IMAGE_CMD_OPCODE_OP_GET_DATA_V2,
} app_vendor_image_cmd_opcode_op_t;

typedef enum
{
    APP_VENDOR_IMAGE_CMD_OPCODE_CAT_PRODUCT_NAME,
    APP_VENDOR_IMAGE_CMD_OPCODE_CAT_UNIT_OF_MEASURE,
    APP_VENDOR_IMAGE_CMD_OPCODE_CAT_PRODUCT_DESCRIPTION,
    APP_VENDOR_IMAGE_CMD_OPCODE_CAT_BAR_CODE,
    APP_VENDOR_IMAGE_CMD_OPCODE_CAT_BAR_CODE_NUM,
    APP_VENDOR_IMAGE_CMD_OPCODE_CAT_PIC,
    APP_VENDOR_IMAGE_CMD_OPCODE_CAT_PIC_DATA,
    APP_VENDOR_IMAGE_CMD_OPCODE_CAT_CURRENCY_CODE,
    APP_VENDOR_IMAGE_CMD_OPCODE_CAT_PRICE_MAJOR,
    APP_VENDOR_IMAGE_CMD_OPCODE_CAT_PRICE_MINOR,
    APP_VENDOR_IMAGE_CMD_OPCODE_CAT_PRODUCT_PRICE
} app_vendor_image_cmd_opcode_cat_t;

typedef enum
{
    APP_VENDOR_IMAGE_RSP_STATUS_SUCCESS,
    APP_VENDOR_IMAGE_RSP_STATUS_INVALID_PARAMETERS,
} app_vendor_image_rsp_status_t;

typedef struct
{
    u8 opcode;
} app_vendor_image_cmd_hdr_t;

typedef struct
{
    app_vendor_image_cmd_hdr_t hdr;
    u8                         pattern;
} app_vendor_image_cmd_clear_t;

typedef struct
{
    app_vendor_image_cmd_hdr_t hdr;
} app_vendor_image_cmd_get_length_t;

typedef struct
{
    app_vendor_image_cmd_hdr_t hdr;
    u8                         offset;
    u8                         len;
} app_vendor_image_cmd_get_data_t;

typedef struct
{
    app_vendor_image_cmd_hdr_t hdr;
    u8                         offset;
    u8                         data[];
} app_vendor_image_cmd_patch_t;

typedef struct
{
    app_vendor_image_cmd_hdr_t hdr;
    u16                        offset;
    u8                         len;
} app_vendor_image_cmd_get_data_v2_t;

typedef struct
{
    app_vendor_image_cmd_hdr_t hdr;
    u16                        offset;
    u8                         data[];
} app_vendor_image_cmd_patch_v2_t;

typedef struct
{
    u8 rsp_opcode;
    u8 req_opcode;
    u8 status;
    u8 params[];
} app_vendor_image_rsp_t;

typedef void (*op_handler)(u8 *cmd, u8 cmdLength, blc_eslss_controlPointResponseHdr_t *rsp);

typedef struct
{
    u8         opcode;
    op_handler handler;
    u8         minCmdLength;
    u8         maxCmdLength;
} app_vendor_op_handlers_t;

typedef struct
{
    u8  cat;
    u8 *data;
    u16 dataLength;
} app_vendor_cat_data_t;

typedef struct
{
    char currency_code[CURRENCY_CODE_LEN];
    char currency_char;
} app_vendor_currency_code_t;

_attribute_data_retention_ app_vendor_currency_code_t currency_codes[] = {
    {"CNY", CNY_CHAR},
    {"USD", USD_CHAR},
    {"EUR", EUR_CHAR},
    {"GBP", GBP_CHAR},
};

_attribute_data_retention_ static u8 product_name[PRODUCT_NAME_LEN];
_attribute_data_retention_ static u8 product_desc[PRODUCT_DESC_LEN];
_attribute_data_retention_ static u8 product_price[PRODUCT_PRICE_LEN];
_attribute_data_retention_ static u8 product_price_major[PRODUCT_PRICE_MAJOR_LEN];
_attribute_data_retention_ static u8 product_price_minor[PRODUCT_PRICE_MINOR_LEN];
_attribute_data_retention_ static u8 currency_code[CURRENCY_CODE_LEN];
_attribute_data_retention_ static u8 unit_of_measure[UNIT_OF_MEASURE_LEN];
_attribute_data_retention_ static u8 bar_code[BAR_CODE_LEN];
_attribute_data_retention_ static u8 bar_code_num[BAR_CODE_NUM_LEN];
_attribute_data_retention_ static u8 pic[PIC_LEN];
static const u8                      pics[] = {
    // Picture 0
    0xef,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xe1,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xc4,
    0x7f,
    0xff,
    0xff,
    0xff,
    0xff,
    0xee,
    0x3f,
    0xff,
    0xff,
    0xff,
    0xff,
    0xe7,
    0x8f,
    0xff,
    0xff,
    0xff,
    0xff,
    0xf3,
    0xe3,
    0xff,
    0xff,
    0xff,
    0xff,
    0xf3,
    0xf1,
    0xff,
    0xff,
    0xff,
    0xff,
    0xf9,
    0xfc,
    0x7f,
    0xff,
    0xff,
    0xff,
    0xf9,
    0xff,
    0x3f,
    0xff,
    0xff,
    0xff,
    0xfc,
    0xff,
    0x8f,
    0xff,
    0xff,
    0xff,
    0xfe,
    0xff,
    0xe3,
    0xff,
    0xff,
    0xff,
    0xfe,
    0x4f,
    0xf1,
    0xff,
    0xff,
    0xff,
    0xff,
    0x0f,
    0xf0,
    0xff,
    0xff,
    0xff,
    0xff,
    0x9f,
    0xe6,
    0x3f,
    0xff,
    0xff,
    0xff,
    0x9f,
    0xcf,
    0x9f,
    0xff,
    0xff,
    0xff,
    0xcf,
    0xdf,
    0xc7,
    0xff,
    0xff,
    0xff,
    0xef,
    0xff,
    0xf3,
    0xff,
    0xff,
    0xff,
    0xe7,
    0xff,
    0xf9,
    0xff,
    0xff,
    0xff,
    0xf3,
    0xff,
    0xfc,
    0xff,
    0xff,
    0xff,
    0xf3,
    0xff,
    0xfe,
    0x3f,
    0xff,
    0xff,
    0xf9,
    0xff,
    0xff,
    0xbf,
    0xff,
    0xff,
    0xfc,
    0xff,
    0xff,
    0x9f,
    0xff,
    0xff,
    0xfe,
    0x7f,
    0xff,
    0xdf,
    0xff,
    0xff,
    0xfe,
    0x79,
    0xff,
    0xcf,
    0xff,
    0xff,
    0xff,
    0x33,
    0xff,
    0xcf,
    0xff,
    0xff,
    0xff,
    0x87,
    0xff,
    0xcf,
    0xff,
    0xff,
    0xff,
    0x8f,
    0xff,
    0xc0,
    0x3f,
    0xff,
    0xff,
    0xcf,
    0xff,
    0xc3,
    0x0f,
    0xff,
    0xff,
    0xe7,
    0xff,
    0xcd,
    0xe7,
    0xff,
    0xff,
    0xf3,
    0xff,
    0x80,
    0x73,
    0xff,
    0xff,
    0xfb,
    0xff,
    0x1f,
    0x79,
    0xff,
    0xff,
    0xf8,
    0xfe,
    0x47,
    0xf1,
    0xff,
    0xff,
    0xfc,
    0x10,
    0x21,
    0xc3,
    0xff,
    0xff,
    0xff,
    0x81,
    0x38,
    0x0f,
    0xff,
    0xff,
    0xff,
    0xfc,
    0xbf,
    0x9f,
    0xff,
    0xff,
    0xff,
    0xf9,
    0x9f,
    0xdf,
    0xff,
    0xff,
    0xff,
    0xf9,
    0x8f,
    0xcf,
    0xff,
    0xff,
    0xff,
    0xfd,
    0xe7,
    0xef,
    0xff,
    0xff,
    0xff,
    0xf9,
    0xe2,
    0xe7,
    0xff,
    0xff,
    0xff,
    0xfc,
    0xf0,
    0x07,
    0xff,
    0xff,
    0xff,
    0xfc,
    0xe7,
    0x8f,
    0xff,
    0xff,
    0xff,
    0xfe,
    0x67,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0x27,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0x8f,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xdf,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    // Picture 1
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xfc,
    0x0f,
    0xff,
    0xff,
    0xff,
    0xff,
    0xc0,
    0x01,
    0xff,
    0xff,
    0xff,
    0xff,
    0x87,
    0xf8,
    0x7f,
    0xff,
    0xff,
    0xfe,
    0x3f,
    0xfe,
    0x3f,
    0xff,
    0xff,
    0xfc,
    0x7f,
    0xff,
    0x1f,
    0xff,
    0xff,
    0xf9,
    0xff,
    0xff,
    0xcf,
    0xff,
    0xff,
    0xf1,
    0xff,
    0xff,
    0xe7,
    0xff,
    0xff,
    0xf3,
    0xff,
    0xff,
    0xf3,
    0xff,
    0xff,
    0xe7,
    0xff,
    0xff,
    0xf3,
    0xff,
    0xff,
    0xe7,
    0xff,
    0xff,
    0xf9,
    0xff,
    0xff,
    0xcf,
    0xff,
    0xff,
    0xf9,
    0xff,
    0xff,
    0xcf,
    0xff,
    0xff,
    0xfd,
    0xff,
    0xff,
    0xcf,
    0xff,
    0xff,
    0xf8,
    0xff,
    0xff,
    0xdf,
    0xff,
    0xff,
    0xfd,
    0xff,
    0xff,
    0x9f,
    0xff,
    0xff,
    0xfc,
    0xff,
    0xff,
    0xcf,
    0xff,
    0xff,
    0xfc,
    0xff,
    0xff,
    0xdf,
    0xff,
    0xff,
    0xfc,
    0xff,
    0xff,
    0xcf,
    0xff,
    0xff,
    0xfc,
    0xff,
    0xff,
    0xcf,
    0xff,
    0xff,
    0xfc,
    0xff,
    0xff,
    0xcf,
    0xff,
    0xff,
    0xfe,
    0x7f,
    0xff,
    0xef,
    0xff,
    0xff,
    0xfe,
    0x7f,
    0xff,
    0xe7,
    0x7f,
    0xff,
    0xfe,
    0x7f,
    0xff,
    0xe7,
    0xbf,
    0xff,
    0xff,
    0x3f,
    0xff,
    0xf3,
    0xbf,
    0xff,
    0xff,
    0x9f,
    0xff,
    0xf3,
    0xdf,
    0xff,
    0xff,
    0x8f,
    0xff,
    0xf9,
    0xef,
    0xff,
    0xff,
    0xe7,
    0xff,
    0xfc,
    0xef,
    0xff,
    0xff,
    0xe1,
    0xff,
    0xfc,
    0xf7,
    0xff,
    0xff,
    0xf8,
    0xff,
    0xfe,
    0x7b,
    0xff,
    0xff,
    0xfc,
    0x3f,
    0xff,
    0x3d,
    0xff,
    0xff,
    0xfb,
    0x1f,
    0xff,
    0x9e,
    0xff,
    0xff,
    0xfd,
    0x9f,
    0xff,
    0x8f,
    0x7f,
    0xff,
    0xfd,
    0xcf,
    0xff,
    0xe7,
    0xbf,
    0xff,
    0xf3,
    0xcf,
    0xff,
    0xe3,
    0xff,
    0xff,
    0xef,
    0xe7,
    0xff,
    0xf9,
    0xfb,
    0xff,
    0xdf,
    0xef,
    0xff,
    0xf8,
    0xfc,
    0xff,
    0xff,
    0xe7,
    0xff,
    0xfe,
    0x3f,
    0xff,
    0xef,
    0xcf,
    0xff,
    0xff,
    0x0f,
    0xff,
    0xf7,
    0xe3,
    0xff,
    0xff,
    0xc7,
    0xff,
    0xf7,
    0xc3,
    0xff,
    0xff,
    0xf0,
    0xff,
    0xcf,
    0x8f,
    0xff,
    0xff,
    0xfc,
    0x1f,
    0xbf,
    0x1f,
    0xff,
    0xff,
    0xff,
    0x01,
    0x7e,
    0x3f,
    0xff,
    0xff,
    0xff,
    0xe0,
    0x00,
    0xff,
    0xff,
    0xff,
    0xff,
    0xfe,
    0x81,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    // Picture 2
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xbf,
    0xff,
    0xff,
    0xff,
    0xff,
    0xfe,
    0x3f,
    0xff,
    0xff,
    0xff,
    0xff,
    0xe0,
    0x7f,
    0xff,
    0xff,
    0xff,
    0xff,
    0xe0,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xf0,
    0x7f,
    0xff,
    0xff,
    0xff,
    0xff,
    0xf2,
    0x1f,
    0xff,
    0xff,
    0xff,
    0xff,
    0xe7,
    0x9f,
    0xff,
    0xff,
    0xff,
    0xff,
    0xe7,
    0xc7,
    0xff,
    0xff,
    0xff,
    0xff,
    0xce,
    0x13,
    0xff,
    0xff,
    0xff,
    0xff,
    0xc4,
    0x91,
    0xff,
    0xff,
    0xff,
    0xff,
    0xc4,
    0x18,
    0x7f,
    0xff,
    0xff,
    0xff,
    0xc4,
    0x3e,
    0x7f,
    0xff,
    0xff,
    0xff,
    0xc3,
    0xf7,
    0x3f,
    0xff,
    0xff,
    0xff,
    0xc3,
    0xe1,
    0x1f,
    0xff,
    0xff,
    0xff,
    0xc1,
    0xe0,
    0x8f,
    0xff,
    0xff,
    0xff,
    0xe0,
    0xc9,
    0xc7,
    0xff,
    0xff,
    0xff,
    0xe4,
    0x41,
    0xf3,
    0xff,
    0xff,
    0xff,
    0xe2,
    0x73,
    0xf1,
    0xff,
    0xff,
    0xff,
    0xf7,
    0x3f,
    0x09,
    0xff,
    0xff,
    0xff,
    0xf3,
    0x0e,
    0x0c,
    0xff,
    0xff,
    0xff,
    0xf3,
    0xce,
    0x4c,
    0x7f,
    0xff,
    0xff,
    0xfb,
    0xe7,
    0x0e,
    0x7f,
    0xff,
    0xff,
    0xf9,
    0xf3,
    0x9f,
    0x3f,
    0xff,
    0xff,
    0xf9,
    0xf0,
    0xe1,
    0x1f,
    0xff,
    0xff,
    0xfc,
    0xfc,
    0xe0,
    0x9f,
    0xff,
    0xff,
    0xfc,
    0x7e,
    0x64,
    0xcf,
    0xff,
    0xff,
    0xfe,
    0x7f,
    0x21,
    0xc7,
    0xff,
    0xff,
    0xff,
    0x7f,
    0x33,
    0xe7,
    0xff,
    0xff,
    0xfe,
    0x7f,
    0x9f,
    0x73,
    0xff,
    0xff,
    0xff,
    0x3f,
    0x8f,
    0x19,
    0xff,
    0xff,
    0xff,
    0x3f,
    0x86,
    0x49,
    0xff,
    0xff,
    0xff,
    0x3f,
    0xc6,
    0x0c,
    0xff,
    0xff,
    0xff,
    0x9f,
    0xc0,
    0x1e,
    0x7f,
    0xff,
    0xff,
    0x1f,
    0xc4,
    0xfe,
    0x7f,
    0xff,
    0xff,
    0x9f,
    0xec,
    0x70,
    0x7f,
    0xff,
    0xff,
    0xcf,
    0xee,
    0x60,
    0x3f,
    0xff,
    0xff,
    0x9f,
    0xe7,
    0x20,
    0x3f,
    0xff,
    0xff,
    0xcf,
    0xe7,
    0x03,
    0x9f,
    0xff,
    0xff,
    0xc7,
    0xe7,
    0xc3,
    0x8f,
    0xff,
    0xff,
    0xe7,
    0xf7,
    0xe0,
    0x1f,
    0xff,
    0xff,
    0xf3,
    0xe7,
    0xff,
    0x9f,
    0xff,
    0xff,
    0xf1,
    0xf7,
    0xff,
    0xff,
    0xff,
    0xff,
    0xf8,
    0xf3,
    0xff,
    0xff,
    0xff,
    0xff,
    0xfc,
    0x03,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0x2f,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    // Picture 3
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0x3f,
    0xff,
    0xff,
    0xff,
    0xff,
    0xfe,
    0x1f,
    0xff,
    0xff,
    0xff,
    0xff,
    0xf8,
    0x9f,
    0xff,
    0xff,
    0xff,
    0xff,
    0xf1,
    0xcf,
    0xff,
    0xff,
    0xff,
    0xff,
    0xe3,
    0x87,
    0xff,
    0xff,
    0xff,
    0xff,
    0xc7,
    0x07,
    0xff,
    0xff,
    0xff,
    0xff,
    0x8e,
    0x33,
    0xff,
    0xff,
    0xff,
    0xff,
    0x9c,
    0xf3,
    0xff,
    0xff,
    0xff,
    0xff,
    0x39,
    0xf9,
    0xff,
    0xff,
    0xff,
    0xff,
    0x33,
    0xf9,
    0xff,
    0xff,
    0xff,
    0xfe,
    0x73,
    0xfc,
    0xff,
    0xff,
    0xff,
    0xfe,
    0x67,
    0xfc,
    0x7f,
    0xff,
    0xff,
    0xfc,
    0xcf,
    0xfe,
    0x7f,
    0xff,
    0xff,
    0xfc,
    0xcf,
    0xff,
    0x3f,
    0xff,
    0xff,
    0xf9,
    0xcf,
    0xff,
    0x3f,
    0xff,
    0xff,
    0xf9,
    0x9e,
    0x03,
    0x9f,
    0xff,
    0xff,
    0xf9,
    0x9e,
    0x63,
    0x9f,
    0xff,
    0xff,
    0xf9,
    0x9e,
    0xe7,
    0xcf,
    0xff,
    0xff,
    0xfb,
    0x9e,
    0x47,
    0xc7,
    0xff,
    0xff,
    0xf3,
    0xbe,
    0x0f,
    0xe7,
    0xff,
    0xff,
    0xf3,
    0xbf,
    0x9f,
    0xf3,
    0xff,
    0xff,
    0xf3,
    0xbf,
    0xff,
    0xf3,
    0xff,
    0xff,
    0xf3,
    0xbf,
    0xff,
    0xf9,
    0xff,
    0xff,
    0xf3,
    0xbf,
    0xff,
    0xf9,
    0xff,
    0xff,
    0xfb,
    0x9f,
    0x87,
    0xfc,
    0xff,
    0xff,
    0xf9,
    0x9f,
    0x03,
    0xfc,
    0xff,
    0xff,
    0xf9,
    0x9e,
    0x73,
    0xfe,
    0x7f,
    0xff,
    0xf9,
    0x9e,
    0x67,
    0xfe,
    0x3f,
    0xff,
    0xf9,
    0xce,
    0x67,
    0xff,
    0x3f,
    0xff,
    0xfc,
    0xcf,
    0x0f,
    0x87,
    0x9f,
    0xff,
    0xfc,
    0xe7,
    0xbf,
    0x03,
    0x9f,
    0xff,
    0xfc,
    0x67,
    0xfe,
    0x73,
    0xcf,
    0xff,
    0xfe,
    0x73,
    0xfe,
    0x73,
    0xcf,
    0xff,
    0xff,
    0x39,
    0xfe,
    0x27,
    0xe7,
    0xff,
    0xff,
    0x38,
    0xff,
    0x0f,
    0xe3,
    0xff,
    0xff,
    0x9c,
    0x7f,
    0xff,
    0xf3,
    0xff,
    0xff,
    0xce,
    0x3f,
    0xff,
    0xf9,
    0xff,
    0xff,
    0xc7,
    0x8f,
    0xff,
    0xf9,
    0xff,
    0xff,
    0xe3,
    0xc3,
    0xff,
    0xf0,
    0xff,
    0xff,
    0xf1,
    0xf0,
    0x7f,
    0x80,
    0xff,
    0xff,
    0xfc,
    0x7c,
    0x00,
    0x0e,
    0x7f,
    0xff,
    0xfe,
    0x3f,
    0xc0,
    0xfe,
    0x7f,
    0xff,
    0xff,
    0x87,
    0xff,
    0xf8,
    0x7f,
    0xff,
    0xff,
    0xc0,
    0xff,
    0xc1,
    0xff,
    0xff,
    0xff,
    0xf8,
    0x00,
    0x07,
    0xff,
    0xff,
    0xff,
    0xff,
    0x80,
    0x7f,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    // Picture 4
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0x00,
    0x01,
    0xff,
    0xff,
    0xff,
    0xf8,
    0x00,
    0x00,
    0x3f,
    0xff,
    0xff,
    0xf0,
    0x73,
    0xce,
    0x0f,
    0xff,
    0xff,
    0xc4,
    0x79,
    0x9f,
    0x07,
    0xf7,
    0xff,
    0xc0,
    0xf8,
    0x1f,
    0x83,
    0x03,
    0xff,
    0x81,
    0xfc,
    0x3f,
    0xc0,
    0x03,
    0xff,
    0x11,
    0xfe,
    0x7f,
    0x80,
    0x60,
    0x3f,
    0x21,
    0xfc,
    0x3f,
    0x80,
    0xe0,
    0x3f,
    0x24,
    0xf8,
    0x1f,
    0x30,
    0x77,
    0x3f,
    0x0c,
    0x71,
    0x8e,
    0x38,
    0x7e,
    0x3f,
    0x0e,
    0x33,
    0xcc,
    0x7c,
    0x7e,
    0x3f,
    0x1f,
    0x27,
    0xe0,
    0xfc,
    0x7e,
    0x07,
    0x3f,
    0x87,
    0xe1,
    0xfe,
    0x7f,
    0xc3,
    0x3f,
    0x8f,
    0xf1,
    0xfe,
    0x3f,
    0xe3,
    0x1f,
    0x87,
    0xe1,
    0xfe,
    0x7f,
    0x83,
    0x0f,
    0x27,
    0xe4,
    0xfc,
    0x7e,
    0x0f,
    0x0e,
    0x33,
    0xcc,
    0x78,
    0x7e,
    0x3f,
    0x24,
    0x71,
    0x8e,
    0x38,
    0x7f,
    0x3f,
    0x20,
    0xf8,
    0x1f,
    0x30,
    0xe3,
    0x3f,
    0x31,
    0xfc,
    0x3f,
    0x80,
    0xe0,
    0x3f,
    0x91,
    0xfc,
    0x7f,
    0x80,
    0x20,
    0x3f,
    0x80,
    0xfc,
    0x3f,
    0xc0,
    0x03,
    0xff,
    0xc4,
    0x78,
    0x1f,
    0x83,
    0xc7,
    0xff,
    0xe2,
    0x39,
    0x9f,
    0x07,
    0xff,
    0xff,
    0xf0,
    0x00,
    0x00,
    0x1f,
    0xff,
    0xff,
    0xfc,
    0x00,
    0x00,
    0x7f,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    // Picture 5
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xf8,
    0x03,
    0xff,
    0xe0,
    0x7f,
    0xff,
    0xf0,
    0x00,
    0xff,
    0x00,
    0x0f,
    0xff,
    0xc3,
    0xf8,
    0x7e,
    0x1f,
    0x8f,
    0xff,
    0x8f,
    0xfe,
    0x38,
    0x7f,
    0xcf,
    0xff,
    0x9f,
    0xff,
    0x11,
    0xff,
    0x9f,
    0xff,
    0xbf,
    0xff,
    0x93,
    0xff,
    0x1f,
    0xff,
    0xbf,
    0xff,
    0xc7,
    0xff,
    0x3f,
    0xff,
    0xff,
    0xfe,
    0x47,
    0xfe,
    0x7f,
    0xff,
    0xff,
    0xf8,
    0x0f,
    0xf8,
    0xff,
    0xff,
    0xff,
    0xf8,
    0x00,
    0x01,
    0xff,
    0xff,
    0xff,
    0xf9,
    0x00,
    0x03,
    0xff,
    0xff,
    0xff,
    0xf8,
    0x27,
    0xf1,
    0xff,
    0xff,
    0xff,
    0xf8,
    0x4f,
    0xfc,
    0xff,
    0xff,
    0xff,
    0xff,
    0x4c,
    0xfe,
    0x7f,
    0xff,
    0xff,
    0xff,
    0xf8,
    0x7f,
    0x3f,
    0xff,
    0xbf,
    0xff,
    0xb0,
    0x7f,
    0x3f,
    0xff,
    0xbf,
    0xff,
    0xa4,
    0x7f,
    0x9f,
    0xff,
    0x9f,
    0xff,
    0x3e,
    0x7f,
    0x9f,
    0xff,
    0xc7,
    0xfc,
    0x72,
    0xff,
    0x1f,
    0xff,
    0xe1,
    0xf0,
    0xc2,
    0xff,
    0x1f,
    0xff,
    0xf0,
    0x01,
    0x81,
    0xff,
    0x9f,
    0xff,
    0xf0,
    0x01,
    0xc9,
    0xff,
    0x9f,
    0xff,
    0xc3,
    0xf8,
    0x01,
    0xff,
    0x9f,
    0xff,
    0x8f,
    0xfe,
    0x03,
    0xff,
    0x1f,
    0xff,
    0x9f,
    0xff,
    0x33,
    0xff,
    0x3f,
    0xff,
    0xbf,
    0xff,
    0xbf,
    0xff,
    0x3f,
    0xff,
    0xbf,
    0xff,
    0xff,
    0xff,
    0x1f,
    0xff,
    0xff,
    0xf0,
    0x7c,
    0xff,
    0x07,
    0xff,
    0xff,
    0xf0,
    0x40,
    0xc3,
    0xe1,
    0xff,
    0xff,
    0xf2,
    0x20,
    0x07,
    0xf8,
    0xff,
    0xff,
    0xf0,
    0x24,
    0x3f,
    0xfc,
    0x7f,
    0xff,
    0xf0,
    0x63,
    0xff,
    0xff,
    0x1f,
    0xff,
    0xfc,
    0xc1,
    0xff,
    0xff,
    0x8f,
    0xff,
    0xff,
    0xc0,
    0x7f,
    0xff,
    0xc7,
    0xff,
    0xff,
    0xc8,
    0x0f,
    0xfe,
    0x07,
    0xbf,
    0xff,
    0x8c,
    0x80,
    0x00,
    0x3f,
    0xbf,
    0xff,
    0x9c,
    0x70,
    0x01,
    0xff,
    0x9f,
    0xff,
    0x1e,
    0x7f,
    0xff,
    0xff,
    0xc7,
    0xfc,
    0x1e,
    0x7f,
    0xff,
    0xff,
    0xe1,
    0xf0,
    0x8e,
    0x3f,
    0xff,
    0xff,
    0xf0,
    0x01,
    0xc7,
    0x3f,
    0xff,
    0xff,
    0xfe,
    0x0f,
    0xe3,
    0x3f,
    0xff,
    0xff,
    0xff,
    0xff,
    0xf1,
    0x3f,
    0xff,
    0xff,
    0xff,
    0xff,
    0xf8,
    0x3f,
    0xff,
    0xff,
    0xff,
    0xff,
    0xfc,
    0x3f,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xf,
    // Picture 6
    0xff,
    0xfc,
    0x0f,
    0x1f,
    0xff,
    0xff,
    0xff,
    0xf0,
    0x9c,
    0x1f,
    0xff,
    0xff,
    0xff,
    0xe1,
    0x90,
    0x1f,
    0xff,
    0xff,
    0xff,
    0xc7,
    0x83,
    0x1f,
    0xff,
    0xff,
    0xff,
    0x8f,
    0x07,
    0x3f,
    0xff,
    0xff,
    0xff,
    0x3f,
    0x1e,
    0x3f,
    0xff,
    0xff,
    0xfe,
    0x7e,
    0x3e,
    0x7f,
    0xff,
    0xff,
    0xfc,
    0x7e,
    0x3e,
    0x7f,
    0xff,
    0xff,
    0xf8,
    0xfe,
    0x7c,
    0xff,
    0xff,
    0xff,
    0xf9,
    0xfc,
    0xfc,
    0xff,
    0xff,
    0xff,
    0xf3,
    0xfc,
    0xfc,
    0xff,
    0xff,
    0xff,
    0xf3,
    0xfc,
    0xf9,
    0xff,
    0xff,
    0xff,
    0xe7,
    0xfc,
    0xf9,
    0xff,
    0xff,
    0xff,
    0xe7,
    0xf9,
    0xf9,
    0xff,
    0xff,
    0xff,
    0xe7,
    0xf9,
    0xf3,
    0xff,
    0xff,
    0xff,
    0xcf,
    0xf9,
    0xf3,
    0xff,
    0xff,
    0xff,
    0xcf,
    0xf9,
    0xf3,
    0xff,
    0xff,
    0xff,
    0xcf,
    0xf9,
    0xf3,
    0xff,
    0xff,
    0xff,
    0xcf,
    0xf9,
    0xf3,
    0xff,
    0xff,
    0xff,
    0xdf,
    0xf9,
    0xf3,
    0xff,
    0xff,
    0xff,
    0x9f,
    0xf9,
    0xf3,
    0xff,
    0xff,
    0xff,
    0x9b,
    0xf9,
    0xf3,
    0xff,
    0xff,
    0xff,
    0x99,
    0xf9,
    0xf3,
    0xff,
    0xff,
    0xff,
    0x99,
    0xf9,
    0xf3,
    0xff,
    0xff,
    0xff,
    0x99,
    0xfc,
    0xf3,
    0xff,
    0xff,
    0xff,
    0xc9,
    0xfc,
    0xf9,
    0xff,
    0xff,
    0xff,
    0xcf,
    0xfc,
    0xf9,
    0xff,
    0xff,
    0xff,
    0xcf,
    0xfe,
    0x79,
    0xff,
    0xff,
    0xff,
    0xcf,
    0xfe,
    0x7c,
    0xff,
    0xff,
    0xff,
    0xcf,
    0x7f,
    0x3c,
    0xff,
    0xff,
    0xff,
    0xe7,
    0x3f,
    0x1e,
    0x7f,
    0xff,
    0xff,
    0xe7,
    0x3f,
    0x9e,
    0x3f,
    0xff,
    0xff,
    0xf3,
    0x9f,
    0xcf,
    0x1f,
    0xff,
    0xff,
    0xf3,
    0x8f,
    0xe7,
    0x9f,
    0xff,
    0xff,
    0xf9,
    0xc7,
    0xf3,
    0xcf,
    0xff,
    0xff,
    0xf8,
    0xe3,
    0xf9,
    0xc7,
    0xff,
    0xff,
    0xfc,
    0xf1,
    0xfc,
    0x63,
    0xff,
    0xff,
    0xfe,
    0x78,
    0xfe,
    0x31,
    0xff,
    0xff,
    0xff,
    0x3c,
    0x7f,
    0x08,
    0xf8,
    0xff,
    0xff,
    0x1e,
    0x3f,
    0x80,
    0x80,
    0x1f,
    0xff,
    0xc7,
    0xff,
    0xf0,
    0x03,
    0x8f,
    0xff,
    0xe3,
    0xff,
    0xfe,
    0x03,
    0xcf,
    0xff,
    0xf0,
    0xff,
    0xff,
    0xe7,
    0x9f,
    0xff,
    0xfc,
    0x3f,
    0xff,
    0xc7,
    0x9f,
    0xff,
    0xff,
    0x03,
    0xfc,
    0x07,
    0x9f,
    0xff,
    0xff,
    0xc0,
    0x00,
    0x07,
    0x9f,
    0xff,
    0xff,
    0xfc,
    0x03,
    0xc7,
    0xdf,
    0xff,
    0xff,
    0xff,
    0xff,
    0xf0,
    0x1f,
    // Picture 7
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0x00,
    0x0f,
    0xff,
    0xff,
    0xff,
    0xfc,
    0x00,
    0x03,
    0xff,
    0xff,
    0xff,
    0xf0,
    0x00,
    0x00,
    0xff,
    0xff,
    0xff,
    0xe0,
    0x7f,
    0xe0,
    0x7f,
    0xff,
    0xff,
    0x81,
    0xff,
    0xf8,
    0x3f,
    0xff,
    0xff,
    0x87,
    0xff,
    0xfe,
    0x1f,
    0xff,
    0xff,
    0x0f,
    0xff,
    0xff,
    0x0f,
    0xff,
    0xc0,
    0x1f,
    0xff,
    0xff,
    0x0f,
    0xff,
    0x00,
    0x1f,
    0xff,
    0xff,
    0x8f,
    0xfc,
    0x00,
    0x01,
    0xc0,
    0x3f,
    0x87,
    0xf8,
    0x1c,
    0x00,
    0x00,
    0x07,
    0xc7,
    0xf0,
    0x7f,
    0x80,
    0x00,
    0x01,
    0xc7,
    0xf0,
    0xff,
    0xe0,
    0x1f,
    0x00,
    0x47,
    0xe1,
    0xff,
    0xc0,
    0xff,
    0xf0,
    0x07,
    0xe0,
    0x03,
    0x83,
    0xff,
    0xfc,
    0x07,
    0xe0,
    0x00,
    0x0f,
    0xff,
    0xfe,
    0x0f,
    0xe0,
    0x00,
    0x1f,
    0xff,
    0xff,
    0x0f,
    0xe0,
    0x00,
    0x0f,
    0xff,
    0xff,
    0x87,
    0xc1,
    0xfc,
    0x01,
    0xff,
    0xff,
    0xc7,
    0xc3,
    0xff,
    0x00,
    0x0f,
    0xff,
    0xc7,
    0x87,
    0xff,
    0xe0,
    0x00,
    0xff,
    0xc3,
    0x8f,
    0xff,
    0xfc,
    0x00,
    0x7f,
    0xe3,
    0x8f,
    0xff,
    0xff,
    0x00,
    0x7f,
    0xe3,
    0x8f,
    0xff,
    0xfc,
    0x00,
    0x7f,
    0xe3,
    0x87,
    0xff,
    0xe0,
    0x01,
    0xff,
    0xc3,
    0xc7,
    0xff,
    0x80,
    0x3f,
    0xff,
    0xc7,
    0xc3,
    0xfe,
    0x01,
    0xff,
    0xff,
    0x87,
    0xe0,
    0xf8,
    0x0f,
    0xff,
    0xff,
    0x8f,
    0xe0,
    0x00,
    0x0f,
    0xff,
    0xff,
    0x0f,
    0xe0,
    0x00,
    0x07,
    0xff,
    0xfe,
    0x07,
    0xe0,
    0x03,
    0x83,
    0xff,
    0xf8,
    0x07,
    0xf1,
    0xff,
    0xc0,
    0x7f,
    0xe0,
    0x07,
    0xf0,
    0xff,
    0xe0,
    0x00,
    0x00,
    0xc7,
    0xf8,
    0x3f,
    0x00,
    0x00,
    0x03,
    0xc7,
    0xfc,
    0x00,
    0x00,
    0x00,
    0x0f,
    0xc7,
    0xfe,
    0x00,
    0x07,
    0xff,
    0xff,
    0x87,
    0xff,
    0x80,
    0x1f,
    0xff,
    0xff,
    0x8f,
    0xff,
    0xf6,
    0x1f,
    0xff,
    0xff,
    0x0f,
    0xff,
    0xff,
    0x0f,
    0xff,
    0xfe,
    0x1f,
    0xff,
    0xff,
    0x83,
    0xff,
    0xfc,
    0x1f,
    0xff,
    0xff,
    0xc0,
    0xff,
    0xf8,
    0x3f,
    0xff,
    0xff,
    0xe0,
    0x1f,
    0xc0,
    0x7f,
    0xff,
    0xff,
    0xf8,
    0x00,
    0x00,
    0xff,
    0xff,
    0xff,
    0xfe,
    0x00,
    0x03,
    0xff,
    0xff,
    0xff,
    0xff,
    0xc0,
    0x1f,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
    0xff,
};

_attribute_data_retention_ static app_vendor_cat_data_t cat_data[] = {
    {APP_VENDOR_IMAGE_CMD_OPCODE_CAT_PRODUCT_NAME,        product_name,        sizeof(product_name) - 1       },
    {APP_VENDOR_IMAGE_CMD_OPCODE_CAT_PRODUCT_PRICE,       product_price,       sizeof(product_price) - 1      },
    {APP_VENDOR_IMAGE_CMD_OPCODE_CAT_PRODUCT_DESCRIPTION, product_desc,        sizeof(product_desc) - 1       },
    {APP_VENDOR_IMAGE_CMD_OPCODE_CAT_BAR_CODE,            bar_code,            sizeof(bar_code)               },
    {APP_VENDOR_IMAGE_CMD_OPCODE_CAT_BAR_CODE_NUM,        bar_code_num,        sizeof(bar_code_num) - 1       },
    {APP_VENDOR_IMAGE_CMD_OPCODE_CAT_PIC,                 pic,                 sizeof(pic)                    },
    {APP_VENDOR_IMAGE_CMD_OPCODE_CAT_CURRENCY_CODE,       currency_code,       sizeof(currency_code) - 1      },
    {APP_VENDOR_IMAGE_CMD_OPCODE_CAT_PRICE_MAJOR,         product_price_major, sizeof(product_price_major) - 1},
    {APP_VENDOR_IMAGE_CMD_OPCODE_CAT_PRICE_MINOR,         product_price_minor, sizeof(product_price_minor) - 1},
    {APP_VENDOR_IMAGE_CMD_OPCODE_CAT_UNIT_OF_MEASURE,     unit_of_measure,     sizeof(unit_of_measure) - 1    },
};

static void app_vendor_fill_response(blc_eslss_controlPointResponseHdr_t *rsp, u8 reqOpcode, u8 status, u8 parametersLen, u8 *params)
{
    blc_eslss_controlPointResponseVendorSpecific_t *vendorRsp  = (blc_eslss_controlPointResponseVendorSpecific_t *)rsp;
    app_vendor_image_rsp_t                         *parameters = (app_vendor_image_rsp_t *)vendorRsp->parameters;

    if (!rsp) {
        return;
    }

    vendorRsp->hdr.opcode = BLC_ESLSS_VENDOR_SPECIFIC_RESPONSE_OPCODE(sizeof(*parameters) + parametersLen);

    parameters->req_opcode = reqOpcode;
    parameters->rsp_opcode = APP_VENDOR_IMAGE_RSP_OPCODE;
    parameters->status     = status;
    if (parametersLen) {
        memcpy(parameters->params, params, parametersLen);
    }
}

static void app_vendor_image_handle_clear(u8 *cmd, u8 cmdLength, blc_eslss_controlPointResponseHdr_t *rsp)
{
    app_vendor_image_cmd_clear_t *cmdClear = (app_vendor_image_cmd_clear_t *)cmd;
    app_vendor_cat_data_t        *data     = NULL;
    (void)cmdLength;

    foreach_arr(i, cat_data)
    {
        if (cat_data[i].cat == OPCODE_CAT(cmdClear->hdr.opcode)) {
            data = &cat_data[i];
            break;
        }
    }

    if (data) {
        memset(data->data, cmdClear->pattern, data->dataLength);
    }

    app_vendor_fill_response(rsp, cmdClear->hdr.opcode, data ? APP_VENDOR_IMAGE_RSP_STATUS_SUCCESS : APP_VENDOR_IMAGE_RSP_STATUS_INVALID_PARAMETERS, 0, NULL);
}

static void app_vendor_image_handle_get_length(u8 *cmd, u8 cmdLength, blc_eslss_controlPointResponseHdr_t *rsp)
{
    app_vendor_image_cmd_get_length_t *cmdGetLength = (app_vendor_image_cmd_get_length_t *)cmd;
    app_vendor_cat_data_t             *data         = NULL;
    u8                                 length[sizeof(u16)];
    (void)cmdLength;

    foreach_arr(i, cat_data)
    {
        if (cat_data[i].cat == OPCODE_CAT(cmdGetLength->hdr.opcode)) {
            data = &cat_data[i];
            u16_to_bstream_le(data->dataLength, length);
            break;
        }
    }

    app_vendor_fill_response(rsp, cmdGetLength->hdr.opcode, data ? APP_VENDOR_IMAGE_RSP_STATUS_SUCCESS : APP_VENDOR_IMAGE_RSP_STATUS_INVALID_PARAMETERS, data ? sizeof(length) : 0, data ? length : NULL);
}

static void app_vendor_image_handle_patch(u8 *cmd, u8 cmdLength, blc_eslss_controlPointResponseHdr_t *rsp)
{
    app_vendor_image_cmd_patch_t *cmdPatch = (app_vendor_image_cmd_patch_t *)cmd;
    app_vendor_cat_data_t        *data     = NULL;
    u8                            patch_length;
    u8                            status;

    foreach_arr(i, cat_data)
    {
        if (cat_data[i].cat == OPCODE_CAT(cmdPatch->hdr.opcode)) {
            data = &cat_data[i];
            break;
        }
    }

    if (!data) {
        status = APP_VENDOR_IMAGE_RSP_STATUS_INVALID_PARAMETERS;
        goto done;
    }

    patch_length = cmdLength - sizeof(*cmdPatch);
    if (patch_length + cmdPatch->offset > data->dataLength) {
        status = APP_VENDOR_IMAGE_RSP_STATUS_INVALID_PARAMETERS;
        goto done;
    }

    memcpy(&data->data[cmdPatch->offset], cmdPatch->data, patch_length);
    status = APP_VENDOR_IMAGE_RSP_STATUS_SUCCESS;

done:
    app_vendor_fill_response(rsp, cmdPatch->hdr.opcode, status, 0, NULL);
}

static void app_vendor_image_handle_get_data(u8 *cmd, u8 cmdLength, blc_eslss_controlPointResponseHdr_t *rsp)
{
    app_vendor_image_cmd_get_data_t *cmdGetData = (app_vendor_image_cmd_get_data_t *)cmd;
    app_vendor_cat_data_t           *data       = NULL;
    u8                               ret_length = 0;
    u8                              *ret_data   = NULL;
    u8                               status;

    (void)cmdLength;

    foreach_arr(i, cat_data)
    {
        if (cat_data[i].cat == OPCODE_CAT(cmdGetData->hdr.opcode)) {
            data = &cat_data[i];
            break;
        }
    }

    if (!data) {
        status = APP_VENDOR_IMAGE_RSP_STATUS_INVALID_PARAMETERS;
        goto done;
    }

    if ((cmdGetData->offset + cmdGetData->len > data->dataLength) || cmdGetData->len > 15) {
        status = APP_VENDOR_IMAGE_RSP_STATUS_INVALID_PARAMETERS;
        goto done;
    }

    ret_length = cmdGetData->len;
    ret_data   = &data->data[cmdGetData->offset];
    status     = APP_VENDOR_IMAGE_RSP_STATUS_SUCCESS;

done:
    app_vendor_fill_response(rsp, cmdGetData->hdr.opcode, status, ret_length, ret_data);
}

static void app_vendor_image_handle_patch_v2(u8 *cmd, u8 cmdLength, blc_eslss_controlPointResponseHdr_t *rsp)
{
    app_vendor_image_cmd_patch_v2_t *cmdPatch = (app_vendor_image_cmd_patch_v2_t *)cmd;
    app_vendor_cat_data_t           *data     = NULL;
    u8                               patch_length;
    u16                              patchOffset;
    u8                               status;

    foreach_arr(i, cat_data)
    {
        if (cat_data[i].cat == OPCODE_CAT(cmdPatch->hdr.opcode)) {
            data = &cat_data[i];
            break;
        }
    }

    if (!data) {
        status = APP_VENDOR_IMAGE_RSP_STATUS_INVALID_PARAMETERS;
        goto done;
    }

    patch_length = cmdLength - sizeof(*cmdPatch);
    BYTE_TO_UINT16(patchOffset, (u8 *)&cmdPatch->offset);
    if (patch_length + patchOffset > data->dataLength) {
        status = APP_VENDOR_IMAGE_RSP_STATUS_INVALID_PARAMETERS;
        goto done;
    }

    memcpy(&data->data[patchOffset], cmdPatch->data, patch_length);
    status = APP_VENDOR_IMAGE_RSP_STATUS_SUCCESS;

done:
    app_vendor_fill_response(rsp, cmdPatch->hdr.opcode, status, 0, NULL);
}

static void app_vendor_image_handle_get_data_v2(u8 *cmd, u8 cmdLength, blc_eslss_controlPointResponseHdr_t *rsp)
{
    app_vendor_image_cmd_get_data_v2_t *cmdGetData = (app_vendor_image_cmd_get_data_v2_t *)cmd;
    app_vendor_cat_data_t              *data       = NULL;
    u16                                 offset;
    u8                                  ret_length = 0;
    u8                                 *ret_data   = NULL;
    u8                                  status;
    (void)cmdLength;

    foreach_arr(i, cat_data)
    {
        if (cat_data[i].cat == OPCODE_CAT(cmdGetData->hdr.opcode)) {
            data = &cat_data[i];
            break;
        }
    }

    if (!data) {
        status = APP_VENDOR_IMAGE_RSP_STATUS_INVALID_PARAMETERS;
        goto done;
    }

    BYTE_TO_UINT16(offset, (u8 *)&cmdGetData->offset);
    if ((offset + cmdGetData->len > data->dataLength) || cmdGetData->len > 15) {
        status = APP_VENDOR_IMAGE_RSP_STATUS_INVALID_PARAMETERS;
        goto done;
    }

    ret_length = cmdGetData->len;
    ret_data   = &data->data[offset];
    status     = APP_VENDOR_IMAGE_RSP_STATUS_SUCCESS;

done:
    app_vendor_fill_response(rsp, cmdGetData->hdr.opcode, status, ret_length, ret_data);
}

static app_vendor_op_handlers_t handlers[] = {
    {APP_VENDOR_IMAGE_CMD_OPCODE_OP_CLEAR,       app_vendor_image_handle_clear,       sizeof(app_vendor_image_cmd_clear_t),       sizeof(app_vendor_image_cmd_clear_t)        },
    {APP_VENDOR_IMAGE_CMD_OPCODE_OP_PATCH,       app_vendor_image_handle_patch,       sizeof(app_vendor_image_cmd_patch_t),       sizeof(app_vendor_image_cmd_patch_t) + 15   },
    {APP_VENDOR_IMAGE_CMD_OPCODE_OP_GET_LENGTH,  app_vendor_image_handle_get_length,  sizeof(app_vendor_image_cmd_get_length_t),  sizeof(app_vendor_image_cmd_get_length_t)   },
    {APP_VENDOR_IMAGE_CMD_OPCODE_OP_GET_DATA,    app_vendor_image_handle_get_data,    sizeof(app_vendor_image_cmd_get_data_t),    sizeof(app_vendor_image_cmd_get_data_t)     },
    {APP_VENDOR_IMAGE_CMD_OPCODE_OP_GET_DATA_V2, app_vendor_image_handle_get_data_v2, sizeof(app_vendor_image_cmd_get_data_v2_t), sizeof(app_vendor_image_cmd_get_data_v2_t)  },
    {APP_VENDOR_IMAGE_CMD_OPCODE_OP_PATCH_V2,    app_vendor_image_handle_patch_v2,    sizeof(app_vendor_image_cmd_patch_v2_t),    sizeof(app_vendor_image_cmd_patch_v2_t) + 14},
};

bool app_vendor_image_handle_vendor_cmd(blc_eslss_controlPointCommandVendorSpecific_t *vendorCmd,
                                        blc_eslss_controlPointResponseHdr_t           *rsp)
{
    u8                        commandLength = (vendorCmd->hdr.opcode & 0xF0) >> 4;
    app_vendor_op_handlers_t *handler       = NULL;
    u8                        opcode;

    rsp = vendorCmd->hdr.eslId == BLC_ESLS_ESL_ID_BROADCAST ? NULL : rsp;

    if (commandLength < 1) {
        return false;
    }

    opcode = vendorCmd->parameters[0];
    foreach_arr(i, handlers)
    {
        if (handlers[i].opcode == OPCODE_OP(opcode)) {
            handler = &handlers[i];
            break;
        }
    }

    if (!handler || commandLength < handler->minCmdLength || commandLength > handler->maxCmdLength) {
        app_vendor_fill_response(rsp, opcode, APP_VENDOR_IMAGE_RSP_STATUS_INVALID_PARAMETERS, 0, NULL);
        return true;
    }

    handler->handler(vendorCmd->parameters, commandLength, rsp);

    return true;
}

static void bar_code_render(u8 *bar_code_rendered)
{
    u8 *ptr = bar_code_rendered;

    foreach_arr(i, bar_code)
    {
        u8 j = 8;

        do {
            j--;
            memset(ptr, (bar_code[i] & (1 << j)) ? 0x00 : 0xFF, 4);
            ptr += 2;
        } while (j != 0);
    }
}

static char get_currency_symbol(char *cur_code)
{
    foreach_arr(i, currency_codes)
    {
        if (strcasecmp(currency_codes[i].currency_code, cur_code) == 0) {
            return currency_codes[i].currency_char;
        }
    }
    return 0;
}

void app_vendor_image_get_image(u8 image[4736])
{
    u16  position_marker = 0;
    char temp_buffer[CURRENCY_CODE_LEN];
    product_name[sizeof(product_name) - 1]               = 0;
    product_desc[sizeof(product_desc) - 1]               = 0;
    product_price_major[sizeof(product_price_major) - 1] = 0;
    product_price_minor[sizeof(product_price_minor) - 1] = 0;
    currency_code[sizeof(currency_code) - 1]             = 0;
    unit_of_measure[sizeof(unit_of_measure) - 1]         = 0;
    bar_code_num[sizeof(bar_code_num) - 1]               = 0;

    GUI_Clear(image, 1);
    GUI_DispStr(image, 6, 0, (const char *)product_name, 1, FONT_8_x_16);

    if ((pic[0] == PIC_DISPLAY) && (pic[1] < (ARRAY_SIZE(pics) / PIC_SIZE))) {
        GUI_DispPic(image, 220, 6, &pics[PIC_SIZE * pic[1]], PIC_WIDTH, PIC_HEIGHT);
    }

    GUI_DispStr(image, 6, 2, (const char *)product_desc, 1, FONT_8_x_16);

    // Display Currency symbol (or currency code if symbol is not available)
    if (currency_code[0] != 0) {
        temp_buffer[0] = get_currency_symbol((char *)currency_code);

        // If currency code is not available, display currency code.
        if (temp_buffer[0] == 0x00) {
            memcpy(temp_buffer, currency_code, CURRENCY_CODE_LEN - 1);
            temp_buffer[CURRENCY_CODE_LEN - 1] = 0x00;
            GUI_DispStr(image, 6, 5, temp_buffer, 1, FONT_8_x_16);
            position_marker += 6 + strlen(temp_buffer) * FONT_8_16_WIDTH;
        } else {
            temp_buffer[1] = 0x00;
            GUI_DispStr(image, 6, 4, temp_buffer, 1, FONT_16_x_32);
            position_marker += 6 + strlen(temp_buffer) * FONT_16_32_WIDTH;
        }
    }

    // Display price major
    GUI_DispStr(image, position_marker, 4, (const char *)product_price_major, 1, FONT_32_x_56);
    position_marker += strlen((char *)product_price_major) * FONT_32_56_WIDTH;

    // Display price minor
    GUI_DispStr(image, position_marker + 4, 4, (const char *)product_price_minor, 1, FONT_16_x_32);

    // Display unit_od_measure
    GUI_DispStr(image, position_marker + 4, 9, (const char *)unit_of_measure, 1, FONT_8_x_16);

    u8 bar_code_rendered[BAR_CODE_LEN * 4 * 8];

    bar_code_render(bar_code_rendered);
    GUI_DispPic(image, 6, 12, bar_code_rendered, sizeof(bar_code) * 8, 16);

    GUI_DispStr(image, 60, 14, (const char *)bar_code_num, 1, FONT_8_x_16);
}

u16 app_vendor_image_get_image_size(void)
{
    return APP_VENDOR_IMAGE_SIZE;
}

#endif
